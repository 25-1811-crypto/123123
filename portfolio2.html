<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš”ìš°ë¬´ íƒ„ë§‰ ê²Œì„ - ëª¨ë“œ ì„ íƒ</title>
    <style>
        body {
            margin: 0;
            background: #000;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            user-select: none;
        }

        canvas {
            display: block;
            margin: 0 auto;
            background: #222;
            border: 2px solid #555;
            width: 800px; /* ì›ë³¸ ì½”ë“œì˜ ê³ ì • ë„ˆë¹„ */
            height: 1000px; /* ì›ë³¸ ì½”ë“œì˜ ê³ ì • ë†’ì´ */
        }

        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 40px;
            font-weight: bold;
            text-align: center;
            display: none;
            z-index: 10;
        }

        #lives,
        #hpBar,
        #characterName,
        #ultimateIcons {
            display: none;
        }

        #lives {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 28px;
            color: red;
            z-index: 10;
        }

        #hpBar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            height: 24px;
            background: #444;
            border-radius: 12px;
            overflow: hidden;
            z-index: 10;
            display: flex;
            position: relative;
        }

        #hpBarInner {
            height: 100%;
            background: #4caf50;
            width: 100%;
            transition: width 0.3s ease-out, background-color 0.3s ease;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #hpRemainingText {
            position: absolute;
            right: 10px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            display: none;
        }


        #characterName {
            position: absolute;
            bottom: 140px;
            left: 10px;
            color: white;
            font-size: 28px;
            font-weight: bold;
            z-index: 10;
        }

        #ultimateIcons {
            position: absolute;
            top: 50px;
            right: 20px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .ultimate-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: cyan;
            box-shadow: 0 0 5px cyan;
        }

        #modeSelect {
            position: absolute;
            width: 100%;
            height: 100%;
            background: black;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        #modeSelect h1 {
            font-size: 48px;
            margin-bottom: 30px;
        }

        #modeSelect button {
            padding: 20px 40px;
            font-size: 24px;
            margin: 10px;
            background: #333;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            /* ì›ë³¸ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        }

        #modeSelect button:hover {
            background: #555;
            /* ì›ë³¸ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        }
    </style>
</head>

<body>

    <div id="modeSelect">
        <h1>ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</h1>
        <button onclick="startGameMode('easy')">ì´ì§€ ëª¨ë“œ</button>
        <button onclick="startGameMode('hard')">í•˜ë“œ ëª¨ë“œ</button>
    </div>

    <div id="message"></div>
    <div id="lives">â¤ï¸â¤ï¸â¤ï¸</div>
    <div id="hpBar">
        <div id="hpBarInner">
            <span id="hpRemainingText"></span>
        </div>
    </div>
    <div id="ultimateIcons"></div>
    <div id="characterName">ë ˆì´ë¬´</div>
    <canvas id="gameCanvas" width="800" height="1000"></canvas>


    <script>
        let gameMode = ''; // í˜„ì¬ ê²Œì„ ëª¨ë“œë¥¼ ì €ì¥í•  ë³€ìˆ˜

        // ê²Œì„ ëª¨ë“œ ì‹œì‘ í•¨ìˆ˜
        function startGameMode(mode) {
            gameMode = mode;
            document.getElementById("modeSelect").style.display = "none"; // ëª¨ë“œ ì„ íƒ í™”ë©´ ìˆ¨ê¹€

            // ì´ë¯¸ì§€ ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
            document.getElementById("message").textContent = "ì´ë¯¸ì§€ ë¡œë”© ì¤‘...";
            document.getElementById("message").style.display = "block";

            // ëª¨ë“  ì´ë¯¸ì§€ ë¡œë”©ì„ ê¸°ë‹¤ë¦° í›„ ê²Œì„ ì´ˆê¸°í™”
            loadImages().then(() => {
                document.getElementById("message").style.display = "none"; // ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¹€
                document.getElementById("lives").style.display = "block"; // ë¼ì´í”„ í‘œì‹œ
                document.getElementById("hpBar").style.display = "flex"; // HP ë°” í‘œì‹œ
                document.getElementById("ultimateIcons").style.display = "flex"; // í•„ì‚´ê¸° ì•„ì´ì½˜ í‘œì‹œ
                document.getElementById("characterName").style.display = "block"; // ìºë¦­í„° ì´ë¦„ í‘œì‹œ

                // í•˜ë“œ ëª¨ë“œì¼ ë•Œë§Œ #hpRemainingTextë¥¼ í‘œì‹œ
                if (gameMode === 'hard') {
                    document.getElementById("hpRemainingText").style.display = "block";
                } else {
                    document.getElementById("hpRemainingText").style.display = "none";
                }
                initGame(); // ê²Œì„ ì´ˆê¸°í™” ì‹œì‘
            }).catch(error => {
                console.error("ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨:", error);
                document.getElementById("message").textContent = "ì˜¤ë¥˜: ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.";
                document.getElementById("message").style.display = "block";
            });
        }

        // ì´ë¯¸ì§€ ë¡œë”© í•¨ìˆ˜
        function loadImages() {
            return new Promise((resolve, reject) => {
                let imagesToLoad = 4; // ë¡œë“œí•  ì´ë¯¸ì§€ ê°œìˆ˜

                const playerImg = new Image();
                playerImg.crossOrigin = "anonymous";
                // í”Œë ˆì´ì–´ ì´ë¯¸ì§€ URLì„ ìœ íš¨í•œ placeholder ì´ë¯¸ì§€ë¡œ ë³€ê²½
                playerImg.src = "https://lh6.googleusercontent.com/proxy/jrzFpj_POiLSNyg6pl6MVsT1_HLNK4QFofFPFM2_2UhORrnhaLF_jk7eAkkJ5LKKjqiLbby9cWUpZ3zzIcDEKtO2U5FKt99kER3U8bQ2G5L8XDxoXR_vR_luBXYcpeCkV5LxrjLQECMpoADxnw-k6Yrcw4YLH73ldsqYi6rr1RwzzLNdmQ";

                const enemyImg = new Image();
                enemyImg.crossOrigin = "anonymous";
                enemyImg.src = "https://static-cdn.jtvnw.net/jtv_user_pictures/d5352573-234b-4369-9cce-e1b4dda73fb6-profile_image-300x300.jpeg";

                const enemyPhase2Img = new Image();
                enemyPhase2Img.crossOrigin = "anonymous";
                enemyPhase2Img.src = "https://image.zeta-ai.io/profile-image/cde6be35-35b2-419a-b831-8490002257a9/21e3f3ae-74a7-40ae-aca5-e0d3d6835162.jpeg?w=3840&q=75&f=webp";

                const yukariImg = new Image();
                yukariImg.crossOrigin = "anonymous";
                yukariImg.src = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSkTvdVEq4_y1XVQPKAFeSkrRo9gxEe0WHuRA&s";

                // ëª¨ë“  ì´ë¯¸ì§€ê°€ ë¡œë“œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
                const checkLoad = () => {
                    imagesToLoad--;
                    if (imagesToLoad === 0) {
                        // ëª¨ë“  ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ë©´ ì „ì—­ ë³€ìˆ˜ì— í• ë‹¹í•˜ê³  resolve
                        window.playerImg = playerImg;
                        window.enemyImg = enemyImg;
                        window.enemyPhase2Img = enemyPhase2Img;
                        window.yukariImg = yukariImg;
                        resolve();
                    }
                };

                playerImg.onload = checkLoad;
                enemyImg.onload = checkLoad;
                enemyPhase2Img.onload = checkLoad;
                yukariImg.onload = checkLoad;

                playerImg.onerror = reject;
                enemyImg.onerror = reject;
                enemyPhase2Img.onerror = reject;
                yukariImg.onerror = reject;
            });
        }


        // ê²Œì„ ì´ˆê¸°í™” í•¨ìˆ˜
        function initGame() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const messageEl = document.getElementById('message');
            const livesEl = document.getElementById('lives');
            const hpBarEl = document.getElementById('hpBar');
            const hpBarInnerEl = document.getElementById('hpBarInner');
            const hpRemainingTextEl = document.getElementById('hpRemainingText');
            const ultimateIconsEl = document.getElementById('ultimateIcons');
            const characterNameEl = document.getElementById('characterName');

            // í”Œë ˆì´ì–´ ê°ì²´ ì •ì˜
            const player = {
                x: canvas.width / 2 - 40,
                y: canvas.height - 140,
                width: 80,
                height: 110,
                speed: 7,
                lives: 3,
                bullets: [],
                shootCooldown: 0,
            };

            // ì  ê°ì²´ ì •ì˜
            const enemy = {
                x: canvas.width / 2 - 50,
                y: 70,
                width: 100,
                height: 100,
                currentMaxLifeHp: gameMode === 'hard' ? 300 : 300, // ë‹¨ì¼ í˜ì´ì¦ˆì˜ ìµœëŒ€ HP
                currentLifeHp: gameMode === 'hard' ? 300 : 300,   // í˜„ì¬ í˜ì´ì¦ˆì˜ HP
                totalLives: gameMode === 'hard' ? 3 : 1,         // ì ì˜ ì´ í˜ì´ì¦ˆ ìˆ˜ (í•˜ë“œ 3ì¤„, ì´ì§€ 1ì¤„)
                speed: 1.7,
                direction: 1,
                moveChangeCooldown: 0,
                bullets: [],
                shootCooldown: 0,
                trackingShootCooldown: 0, // ì¶”ì  ì´ì•Œ ì¿¨ë‹¤ìš´
                burstShootCooldown: 0,    // 2í˜ì´ì¦ˆ ì›í˜• í­ë°œ ì´ì•Œ ì¿¨ë‹¤ìš´ (ìƒˆë¡œìš´ íŒ¨í„´ìš©)
            };

            // ì´ë¯¸ì§€ë“¤ì€ loadImages()ì—ì„œ ì „ì—­ ë³€ìˆ˜ë¡œ ì´ë¯¸ ë¡œë“œë¨.
            // ì—¬ê¸°ì„œëŠ” ì´ë¯¸ ë¡œë“œëœ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©.

            let currentEnemyImg = window.enemyImg; // í˜„ì¬ ì  ì´ë¯¸ì§€ë¥¼ ê´€ë¦¬í•˜ëŠ” ë³€ìˆ˜

            const keys = {}; // ëˆŒë¦° í‚¤ ìƒíƒœ ì €ì¥
            let gameOver = false; // ê²Œì„ ì˜¤ë²„ ìƒíƒœ
            let shiftPressed = false; // Shift í‚¤ ëˆŒë¦¼ ìƒíƒœ
            let ultimateCount = 3; // í•„ì‚´ê¸° ì‚¬ìš© ê°€ëŠ¥ íšŸìˆ˜
            let ultimateActive = false; // í•„ì‚´ê¸° í™œì„±í™” ìƒíƒœ
            let ultimateCharacter = null; // í•„ì‚´ê¸° ë°œë™ ì‹œ í‘œì‹œë  ìºë¦­í„° ì´ë¯¸ì§€
            let ultimateDisplayTime = 0; // í•„ì‚´ê¸° ìºë¦­í„° ì´ë¯¸ì§€ í‘œì‹œ ì‹œê°„
            let yukariLaser = null; // ìœ ì¹´ë¦¬ ë ˆì´ì € (Shift + Z ì‚¬ìš© ì‹œ)

            // ì´ì•Œ í´ë˜ìŠ¤ ì •ì˜
            class Bullet {
                constructor(x, y, dx, dy, owner, isSeed = false, burstTriggerY = 0) {
                    this.x = x;
                    this.y = y;
                    this.radius = isSeed ? 8 : 4.5; // ì”¨ì•— ì´ì•Œì€ ë” í¬ê²Œ
                    this.dx = dx;
                    this.dy = dy;
                    this.owner = owner;
                    this.isSeed = isSeed; // ì”¨ì•— ì´ì•Œ ì—¬ë¶€
                    this.burstTriggerY = burstTriggerY; // í­ë°œí•  Y ì¢Œí‘œ
                }

                // ì´ì•Œ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                update() {
                    this.x += this.dx;
                    this.y += this.dy;
                }

                // ì´ì•Œ ê·¸ë¦¬ê¸°
                draw() {
                    if (this.owner === 'yukariLaser') {
                        // ìœ ì¹´ë¦¬ ë ˆì´ì € ê·¸ë¦¬ê¸°
                        ctx.strokeStyle = 'violet';
                        ctx.lineWidth = 5;
                        ctx.beginPath();
                        ctx.moveTo(this.x, this.y);
                        ctx.lineTo(this.x, this.y - 50);
                        ctx.stroke();
                    } else {
                        // ì¼ë°˜ ì´ì•Œ ê·¸ë¦¬ê¸°
                        ctx.fillStyle = this.owner === 'player' ? 'cyan' : 'magenta';
                        if (this.isSeed) { // ì”¨ì•— ì´ì•Œì€ ì›í˜•ìœ¼ë¡œ
                            ctx.fillStyle = 'orange'; // ì”¨ì•— ì´ì•Œ ìƒ‰ìƒ
                        }
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }

                // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°”ëŠ”ì§€ í™•ì¸
                isOffScreen() {
                    return this.x < 0 || this.x > canvas.width || this.y < 0 || this.y > canvas.height;
                }

                // ë‹¤ë¥¸ ê°ì²´ì™€ ì¶©ëŒí–ˆëŠ”ì§€ í™•ì¸ (ê°„ë‹¨í•œ ì‚¬ê°í˜• ì¶©ëŒ)
                collidesWith(obj) {
                    const distX = Math.abs(this.x - (obj.x + obj.width / 2));
                    const distY = Math.abs(this.y - (obj.y + obj.height / 2));
                    return distX < obj.width / 2 && distY < obj.height / 2;
                }

                // ì”¨ì•— ì´ì•Œ í­ë°œ í•¨ìˆ˜ (ì›í˜•ìœ¼ë¡œ ì´ì•Œ ìƒì„±)
                burst() {
                    const newBullets = []; // ìƒˆ ì´ì•Œì„ ë‹´ì„ ë¡œì»¬ ë°°ì—´
                    const numBullets = 12; // í­ë°œ ì‹œ ìƒì„±ë  ì´ì•Œ ìˆ˜
                    const burstSpeed = 3; // í­ë°œ ì´ì•Œì˜ ì†ë„
                    for (let i = 0; i < numBullets; i++) {
                        const angle = (Math.PI * 2 / numBullets) * i; // ì›í˜• ë°°ì¹˜ ê°ë„
                        const dx = burstSpeed * Math.cos(angle);
                        const dy = burstSpeed * Math.sin(angle);
                        newBullets.push(new Bullet(this.x, this.y, dx, dy, 'enemy'));
                    }
                    return newBullets; // ìƒˆ ì´ì•Œ ë°°ì—´ ë°˜í™˜
                }
            }

            // ì  ì›€ì§ì„ ì—…ë°ì´íŠ¸
            function updateEnemyMovement() {
                if (enemy.moveChangeCooldown <= 0) {
                    // 80% í™•ë¥ ë¡œ ë°©í–¥ ë³€ê²½
                    if (Math.random() < 0.8) enemy.direction *= -1;
                    // ì›€ì§ì„ ë³€ê²½ ì¿¨ë‹¤ìš´ ì¬ì„¤ì •
                    enemy.moveChangeCooldown = Math.floor(Math.random() * 40) + 30;
                    // ì†ë„ ëœë¤ ì¬ì„¤ì •
                    enemy.speed = Math.random() * 1 + 1.2;
                } else enemy.moveChangeCooldown--;
                enemy.x += enemy.speed * enemy.direction;
                // í™”ë©´ ê²½ê³„ì— ë„ë‹¬í•˜ë©´ ë°©í–¥ ë°˜ì „
                if (enemy.x <= 20 || enemy.x >= canvas.width - enemy.width - 20) enemy.direction *= -1;
            }

            // í”Œë ˆì´ì–´ ë¼ì´í”„ UI ì—…ë°ì´íŠ¸
            function updateLivesUI() {
                livesEl.textContent = "â¤ï¸".repeat(player.lives);
            }

            // HP ë°” UI ì—…ë°ì´íŠ¸
            function updateHPBar() {
                const percentage = Math.max(0, enemy.currentLifeHp / enemy.currentMaxLifeHp);
                hpBarInnerEl.style.width = `${percentage * 100}%`;

                // HP ë°” ìƒ‰ìƒ ë³€ê²½ (ì”ì—¬ HPì— ë”°ë¼)
                if (percentage < 0.3) {
                    hpBarInnerEl.style.backgroundColor = '#f55'; // ë¹¨ê°„ìƒ‰
                } else if (percentage < 0.6) {
                    hpBarInnerEl.style.backgroundColor = '#fa5'; // ì£¼í™©ìƒ‰
                } else {
                    hpBarInnerEl.style.backgroundColor = '#4caf50'; // ì´ˆë¡ìƒ‰
                }

                // ë‚¨ì€ ì²´ë ¥ ì¤„ ìˆ˜ í‘œì‹œ (í•˜ë“œ ëª¨ë“œë§Œ)
                if (gameMode === 'hard') {
                    hpRemainingTextEl.textContent = `x${enemy.totalLives}`;
                    hpRemainingTextEl.style.display = 'block';
                } else {
                    hpRemainingTextEl.style.display = 'none';
                }
            }

            // í•„ì‚´ê¸° ì•„ì´ì½˜ UI ì—…ë°ì´íŠ¸
            function updateUltimateIcons() {
                ultimateIconsEl.innerHTML = '';
                for (let i = 0; i < ultimateCount; i++) {
                    const icon = document.createElement('div');
                    icon.className = 'ultimate-icon';
                    ultimateIconsEl.appendChild(icon);
                }
            }

            // ë©”ì‹œì§€ í‘œì‹œ
            function showMessage(text) {
                messageEl.textContent = text;
                messageEl.style.display = 'block';
            }

            // ë©”ì‹œì§€ ìˆ¨ê¹€
            function hideMessage() {
                messageEl.style.display = 'none';
            }

            // í•„ì‚´ê¸° ì‚¬ìš©
            function useUltimate() {
                if (ultimateCount <= 0 || ultimateActive || gameOver) return;
                ultimateCount--;
                updateUltimateIcons();
                enemy.bullets = []; // ëª¨ë“  ì  ì´ì•Œ ì œê±°
                ultimateCharacter = shiftPressed ? window.yukariImg : window.playerImg; // í•„ì‚´ê¸° ì‚¬ìš© ìºë¦­í„° ì´ë¯¸ì§€ ì„¤ì •
                ultimateDisplayTime = 90; // í•„ì‚´ê¸° ìºë¦­í„° ì´ë¯¸ì§€ í‘œì‹œ ì‹œê°„ (1.5ì´ˆ)
                ultimateActive = true;
                setTimeout(() => { ultimateActive = false; }, 1500); // 1.5ì´ˆ í›„ í•„ì‚´ê¸° ë¹„í™œì„±í™”
            }

            // ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸
            function update() {
                if (gameOver) return;

                // í”Œë ˆì´ì–´ ì´ë™ ì†ë„ ì¡°ì ˆ (Shift í‚¤ ëˆ„ë¥´ë©´ ëŠë ¤ì§)
                player.speed = shiftPressed ? 3 : 7;
                if (keys['arrowleft']) player.x -= player.speed;
                if (keys['arrowright']) player.x += player.speed;
                if (keys['arrowup']) player.y -= player.speed;
                if (keys['arrowdown']) player.y += player.speed;

                // í”Œë ˆì´ì–´ í™”ë©´ ê²½ê³„ ì œí•œ
                player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
                player.y = Math.max(0, Math.min(canvas.height - player.height, player.y));

                // ì  ì´ë¯¸ì§€ ë³€ê²½ ë¡œì§ (í•˜ë“œ ëª¨ë“œ, ì²´ë ¥ 2ì¤„ ì´í•˜ ì‹œ 2í˜ì´ì¦ˆ ì´ë¯¸ì§€ë¡œ)
                if (gameMode === 'hard' && enemy.totalLives <= 2) {
                    currentEnemyImg = window.enemyPhase2Img;
                } else {
                    currentEnemyImg = window.enemyImg;
                }

                // í”Œë ˆì´ì–´ ì´ì•Œ ì—…ë°ì´íŠ¸ ë° ì¶©ëŒ ì²˜ë¦¬
                player.bullets = player.bullets.filter(b => {
                    b.update(); // ì´ì•Œ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                    if (b.isOffScreen()) return false; // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ì œê±°
                    if (b.collidesWith(enemy)) {
                        enemy.currentLifeHp -= 10; // ì  HP ê°ì†Œ
                        if (enemy.currentLifeHp <= 0) {
                            enemy.totalLives--; // ì  í˜ì´ì¦ˆ ê°ì†Œ
                            if (enemy.totalLives <= 0) {
                                gameOver = true;
                                showMessage("ğŸ‰ ìš”ìš°ë¬´ë¥¼ ì´ê²¼ìŠµë‹ˆë‹¤!"); // ê²Œì„ ìŠ¹ë¦¬ ë©”ì‹œì§€
                            } else {
                                enemy.currentLifeHp = enemy.currentMaxLifeHp; // ë‹¤ìŒ í˜ì´ì¦ˆë¡œ ì „í™˜, HP ì´ˆê¸°í™”
                                enemy.bullets = []; // ì  ì´ì•Œ ì´ˆê¸°í™”
                            }
                        }
                        return false; // ì´ì•Œì´ ì ì—ê²Œ ë§ì•˜ìœ¼ë¯€ë¡œ ì œê±°
                    }
                    return true; // ì´ì•Œ ìœ ì§€
                });

                // ìœ ì¹´ë¦¬ ë ˆì´ì € ì—…ë°ì´íŠ¸ ë° ì¶©ëŒ ì²˜ë¦¬
                if (yukariLaser) {
                    yukariLaser.update();
                    if (yukariLaser.isOffScreen() || yukariLaser.collidesWith(enemy)) {
                        if (yukariLaser.collidesWith(enemy)) {
                            enemy.currentLifeHp -= 20; // ì  HP ê°ì†Œ (ë ˆì´ì €ëŠ” ë” í° í”¼í•´)
                            if (enemy.currentLifeHp <= 0) {
                                enemy.totalLives--;
                                if (enemy.totalLives <= 0) {
                                    gameOver = true;
                                    showMessage("ğŸ‰ ìš”ìš°ë¬´ë¥¼ ì´ê²¼ìŠµë‹ˆë‹¤!");
                                } else {
                                    enemy.currentLifeHp = enemy.currentMaxLifeHp;
                                    enemy.bullets = [];
                                }
                            }
                        }
                        yukariLaser = null; // ë ˆì´ì € ì œê±°
                    }
                }

                // ì¼ë°˜ ì  ì›€ì§ì„ ë° ê³µê²© íŒ¨í„´ ì‹¤í–‰
                updateEnemyMovement(); // ì¼ë°˜ ì  ì›€ì§ì„

                // ì¼ë°˜ ì´ì•Œ ë°œì‚¬ ë° ì—…ë°ì´íŠ¸
                if (enemy.shootCooldown <= 0) {
                    const bulletSpeed = 4;
                    const centerX = enemy.x + enemy.width / 2;
                    const centerY = enemy.y + enemy.height;

                    // ì¼ë°˜ ì´ì•Œ íŒ¨í„´
                    for (let angle = -0.3; angle <= 0.3; angle += 0.3) {
                        const dx = bulletSpeed * Math.sin(angle);
                        const dy = bulletSpeed * Math.cos(angle);
                        enemy.bullets.push(new Bullet(centerX, centerY, dx, dy, 'enemy'));
                    }
                    enemy.shootCooldown = 60; // ì¼ë°˜ ì´ì•Œ ì¿¨ë‹¤ìš´ (1ì´ˆ)

                    // í•˜ë“œ ëª¨ë“œì—ì„œ ì¶”ì  ì´ì•Œ íŒ¨í„´ ì¶”ê°€
                    if (gameMode === 'hard' && enemy.trackingShootCooldown <= 0) {
                        const targetX = player.x + player.width / 2;
                        const targetY = player.y + player.height / 2;
                        const angleToPlayer = Math.atan2(targetY - centerY, targetX - centerX);
                        const trackingBulletSpeed = 5;
                        const trackingDx = trackingBulletSpeed * Math.cos(angleToPlayer);
                        const trackingDy = trackingBulletSpeed * Math.sin(angleToPlayer);
                        enemy.bullets.push(new Bullet(centerX, centerY, trackingDx, trackingDy, 'enemy'));
                        enemy.trackingShootCooldown = 90; // ì¶”ì  ì´ì•Œ ì¿¨ë‹¤ìš´ (1.5ì´ˆ)
                    }
                } else {
                    enemy.shootCooldown--;
                    if (gameMode === 'hard') {
                        enemy.trackingShootCooldown--;
                    }
                }

                // í•˜ë“œ ëª¨ë“œ 2í˜ì´ì¦ˆ ìƒˆë¡œìš´ íŒ¨í„´: í­ë°œí•˜ëŠ” ì”¨ì•— ì´ì•Œ
                let newBulletsFromBurst = []; // í­ë°œë¡œ ìƒˆë¡œ ìƒì„±ëœ ì´ì•Œì„ ì„ì‹œë¡œ ì €ì¥í•  ë°°ì—´

                if (gameMode === 'hard' && enemy.totalLives <= 2 && enemy.burstShootCooldown <= 0) {
                    const seedSpeed = 2; // ì”¨ì•— ì´ì•Œì˜ ì´ˆê¸° ì†ë„
                    const burstYOffset = 150; // ì”¨ì•— ì´ì•Œì´ í­ë°œí•  ì  ê¸°ì¤€ Y ê±°ë¦¬ (ì¡°ì ˆ ê°€ëŠ¥)
                    const centerX = enemy.x + enemy.width / 2;
                    const centerY = enemy.y + enemy.height; // ì ì˜ ë°œì‚¬ ì§€ì  (ì•„ë˜ìª½)

                    // ì–‘ì˜†ìœ¼ë¡œ 2ê°œì˜ ì”¨ì•— ì´ì•Œ ë°œì‚¬
                    // ì™¼ìª½ ì”¨ì•—
                    enemy.bullets.push(new Bullet(centerX - 30, centerY, -seedSpeed * 0.5, seedSpeed, 'enemy', true, centerY + burstYOffset));
                    // ì˜¤ë¥¸ìª½ ì”¨ì•—
                    enemy.bullets.push(new Bullet(centerX + 30, centerY, seedSpeed * 0.5, seedSpeed, 'enemy', true, centerY + burstYOffset));

                    enemy.burstShootCooldown = 240; // í­ë°œ ì´ì•Œ ì¿¨ë‹¤ìš´ (ì•„ì£¼ ê°€ë”ì”© = 4ì´ˆ)
                } else if (gameMode === 'hard' && enemy.totalLives <= 2) { // 2í˜ì´ì¦ˆì¼ ë•Œë§Œ ì¿¨ë‹¤ìš´ ê°ì†Œ
                    enemy.burstShootCooldown--;
                }

                // ëª¨ë“  ì  ì´ì•Œ ì—…ë°ì´íŠ¸ ë° í”Œë ˆì´ì–´ì™€ì˜ ì¶©ëŒ ì²˜ë¦¬
                enemy.bullets = enemy.bullets.filter(b => {
                    b.update(); // ì´ì•Œ ìœ„ì¹˜ ì—…ë°ì´íŠ¸

                    // ì”¨ì•— ì´ì•Œì´ í­ë°œ ì§€ì ì— ë„ë‹¬í–ˆëŠ”ì§€ í™•ì¸
                    if (b.isSeed && b.y >= b.burstTriggerY) {
                        newBulletsFromBurst.push(...b.burst()); // í­ë°œí•˜ì—¬ ìƒì„±ëœ ì´ì•Œì„ ì„ì‹œ ë°°ì—´ì— ì¶”ê°€
                        return false; // ì”¨ì•— ì´ì•Œì€ ì œê±°
                    }

                    // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ì œê±°
                    if (b.isOffScreen()) return false;

                    // í”Œë ˆì´ì–´ì™€ ì¶©ëŒí–ˆëŠ”ì§€ í™•ì¸ (ì”¨ì•— ì´ì•Œì€ ì§ì ‘ì ì¸ í”¼í•´ë¥¼ ì£¼ì§€ ì•ŠìŒ, í­ë°œ í›„ ìƒì„±ëœ ì´ì•Œì´ í”¼í•´ë¥¼ ì¤Œ)
                    // ë”°ë¼ì„œ !b.isSeed ì¡°ê±´ ì¶”ê°€
                    if (!b.isSeed && b.collidesWith(player)) {
                        player.lives--;
                        updateLivesUI();
                        if (player.lives <= 0) {
                            gameOver = true;
                            showMessage("ğŸ’€ ë‹¹ì‹ ì€ íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤...");
                        }
                        return false; // ì´ì•Œì´ í”Œë ˆì´ì–´ì—ê²Œ ë§ì•˜ìœ¼ë¯€ë¡œ ì œê±°
                    }
                    return true; // ì´ì•Œ ìœ ì§€
                });

                // í•„í„°ë§ëœ ì´ì•Œ ë°°ì—´ì— ìƒˆë¡œ ìƒì„±ëœ í­ë°œ ì´ì•Œë“¤ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
                enemy.bullets = enemy.bullets.concat(newBulletsFromBurst);

                if (player.shootCooldown > 0) player.shootCooldown--; // í”Œë ˆì´ì–´ ì´ì•Œ ì¿¨ë‹¤ìš´ ê°ì†Œ

                updateHPBar(); // HP ë°” UI ì—…ë°ì´íŠ¸
            }

            // ê²Œì„ ìš”ì†Œ ê·¸ë¦¬ê¸°
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height); // ìº”ë²„ìŠ¤ ì§€ìš°ê¸°

                // í˜„ì¬ ì  ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
                if (currentEnemyImg && currentEnemyImg.complete) { // ì´ë¯¸ì§€ ê°ì²´ ì¡´ì¬ ë° ë¡œë”© ì™„ë£Œ í™•ì¸
                    ctx.drawImage(currentEnemyImg, enemy.x, enemy.y, enemy.width, enemy.height);
                }

                // í•„ì‚´ê¸° ë°œë™ ì‹œ ìºë¦­í„° ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
                if (ultimateCharacter && ultimateDisplayTime > 0 && ultimateCharacter.complete) { // ì´ë¯¸ì§€ ë¡œë”© ì™„ë£Œ í™•ì¸
                    ctx.drawImage(ultimateCharacter, canvas.width / 2 - 100, canvas.height / 2 - 100, 200, 200);
                    ultimateDisplayTime--;
                }

                // í”Œë ˆì´ì–´ ìºë¦­í„° ê·¸ë¦¬ê¸° ë° ì´ë¦„ í‘œì‹œ
                if (shiftPressed && window.yukariImg && window.yukariImg.complete) { // ì´ë¯¸ì§€ ê°ì²´ ì¡´ì¬ ë° ë¡œë”© ì™„ë£Œ í™•ì¸
                    ctx.drawImage(window.yukariImg, player.x, player.y, player.width, player.height);
                    characterNameEl.textContent = "ì•¼ì¿ ëª¨ ìœ ì¹´ë¦¬";
                } else {
                    if (window.playerImg && window.playerImg.complete) { // ì´ë¯¸ì§€ ê°ì²´ ì¡´ì¬ ë° ë¡œë”© ì™„ë£Œ í™•ì¸
                        ctx.drawImage(window.playerImg, player.x, player.y, player.width, player.height);
                    }
                    characterNameEl.textContent = "ë ˆì´ë¬´";
                }

                player.bullets.forEach(b => b.draw()); // í”Œë ˆì´ì–´ ì´ì•Œ ê·¸ë¦¬ê¸°
                if (yukariLaser) yukariLaser.draw(); // ìœ ì¹´ë¦¬ ë ˆì´ì € ê·¸ë¦¬ê¸°
                enemy.bullets.forEach(b => b.draw()); // ì  ì´ì•Œ ê·¸ë¦¬ê¸°
            }

            // ë©”ì¸ ê²Œì„ ë£¨í”„
            function gameLoop() {
                update(); // ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸
                draw();   // ê²Œì„ ìš”ì†Œ ê·¸ë¦¬ê¸°
                if (!gameOver) requestAnimationFrame(gameLoop); // ê²Œì„ ì˜¤ë²„ê°€ ì•„ë‹ˆë©´ ë‹¤ìŒ í”„ë ˆì„ ìš”ì²­
            }

            // í‚¤ ëˆŒë¦¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            window.addEventListener('keydown', e => {
                keys[e.key.toLowerCase()] = true; // ëˆŒë¦° í‚¤ ìƒíƒœ trueë¡œ ì„¤ì •
                if (e.key === 'Shift') shiftPressed = true; // Shift í‚¤ ëˆŒë¦¼ ìƒíƒœ ì—…ë°ì´íŠ¸

                // 'Z' í‚¤ (ë°œì‚¬) ì²˜ë¦¬
                if (e.key.toLowerCase() === 'z' && player.shootCooldown === 0 && !gameOver) {
                    const bulletX = player.x + player.width / 2;
                    const bulletY = player.y;

                    if (shiftPressed) {
                        // Shift í‚¤ê°€ ëˆŒë ¤ìˆìœ¼ë©´ ìœ ì¹´ë¦¬ ë ˆì´ì € ë°œì‚¬
                        if (!yukariLaser) { // ë ˆì´ì €ê°€ ì—†ì„ ë•Œë§Œ ìƒì„±
                            yukariLaser = new Bullet(bulletX, bulletY, 0, -20, 'yukariLaser');
                        }
                    } else {
                        // Shift í‚¤ê°€ ëˆŒë ¤ìˆì§€ ì•Šìœ¼ë©´ ì¼ë°˜ ì´ì•Œ ë°œì‚¬
                        player.bullets.push(new Bullet(bulletX, bulletY, 0, -10, 'player'));
                    }
                    player.shootCooldown = 12; // í”Œë ˆì´ì–´ ì´ì•Œ ì¿¨ë‹¤ìš´ (0.2ì´ˆ)
                }

                // 'X' í‚¤ (í•„ì‚´ê¸° ì‚¬ìš©) ì²˜ë¦¬
                if (e.key.toLowerCase() === 'x') useUltimate();
            });

            // í‚¤ ë–¼ëŠ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            window.addEventListener('keyup', e => {
                keys[e.key.toLowerCase()] = false; // í‚¤ ë–¼ë©´ ìƒíƒœ falseë¡œ ì„¤ì •
                if (e.key === 'Shift') {
                    shiftPressed = false; // Shift í‚¤ ë–¼ëŠ” ìƒíƒœ ì—…ë°ì´íŠ¸
                }
            });

            // ê²Œì„ ì‹œì‘ ì‹œ UI ì´ˆê¸°í™” ë° ê²Œì„ ë£¨í”„ ì‹œì‘
            updateLivesUI();
            updateHPBar();
            updateUltimateIcons();
            gameLoop(); // ê²Œì„ ë£¨í”„ ì‹œì‘
        }
    </script>
</body>

</html>